<!-- Autogenerated by weave; DO NOT EDIT -->

# pgvector retriever template

You can use PostgreSQL and `pgvector` as your retriever implementation. Use the
following examples as a starting point and modify it to work with your database
schema.

For the Golang snippet, we use [pgx](https://github.com/jackc/pgx) as the
Postgres client, but you may use another client libaray of your choice.

<section>
  <devsite-selector>
    <section>
      <h3>Node.js (Typescript)</h3>
      <p>```js
            import { embed } from '@genkit-ai/ai/embedder';
            import { Document, defineRetriever, retrieve } from '@genkit-ai/ai/retriever';
            import { defineFlow } from '@genkit-ai/flow';
            import { textEmbeddingGecko } from '@genkit-ai/vertexai';
            import { toSql } from 'pgvector';
            import postgres from 'postgres';
            import { z } from 'zod';

            const sql = postgres({ ssl: false, database: 'recaps' });

            const QueryOptions = z.object({
              show: z.string(),
              k: z.number().optional(),
            });

            const sqlRetriever = defineRetriever(
              {
                name: 'pgvector-myTable',
                configSchema: QueryOptions,
              },
              async (input, options) => {
                const embedding = await embed({
                  embedder: textEmbeddingGecko,
                  content: input,
                });
                const results = await sql
                  SELECT episode_id, season_number, chunk as content
                    FROM embeddings
                    WHERE show_id = ${options.show}
                    ORDER BY embedding <#> ${toSql(embedding)} LIMIT ${options.k ?? 3}
                 ;
                return {
                  documents: results.map((row) => {
                    const { content, ...metadata } = row;
                    return Document.fromText(content, metadata);
                  }),
                };
              }
            );
            ```
      </p>
    </section>
    <section>
      <h3>Go</h3>
      <p>
      ```go
      func defineRetriever(db *sql.DB, embedder *ai.Embedder) *ai.Retriever {
      	f := func(ctx context.Context, req *ai.RetrieverRequest) (*ai.RetrieverResponse, error) {
      		eres, err := embedder.Embed(ctx, &ai.EmbedRequest{Documents: []*ai.Document{req.Document}})
      		if err != nil {
      			return nil, err
      		}
      		rows, err := db.QueryContext(ctx, `
      			SELECT episode_id, season_number, chunk as content
      			FROM embeddings
      			WHERE show_id = $1
      		  	ORDER BY embedding <#> $2
      		  	LIMIT 2`,
      			req.Options, pgv.NewVector(eres.Embeddings[0].Embedding))
      		if err != nil {
      			return nil, err
      		}
      		defer rows.Close()

      		res := &ai.RetrieverResponse{}
      		for rows.Next() {
      			var eid, sn int
      			var content string
      			if err := rows.Scan(&eid, &sn, &content); err != nil {
      				return nil, err
      			}
      			meta := map[string]any{
      				"episode_id":    eid,
      				"season_number": sn,
      			}
      			doc := &ai.Document{
      				Content:  []*ai.Part{ai.NewTextPart(content)},
      				Metadata: meta,
      			}
      			res.Documents = append(res.Documents, doc)
      		}
      		if err := rows.Err(); err != nil {
      			return nil, err
      		}
      		return res, nil
      	}
      	return ai.DefineRetriever(provider, "shows", f)
      }
      ```
      </p>
    </section>

  </devsite-selector>
</section>

And here's how to use the retriever in a flow:

<section>
  <devsite-selector>
    <section>
      <h3>Node.js (Typescript)</h3>
      <p>
       ```js
        // Simple flow to use the sqlRetriever
        export const askQuestionsOnGoT = defineFlow(
          {
            name: 'askQuestionsOnGoT',
            inputSchema: z.string(),
            outputSchema: z.string(),
          },
          async (inputQuestion) => {
            const docs = await retrieve({
              retriever: sqlRetriever,
              query: inputQuestion,
              options: {
                show: 'Game of Thrones',
              },
            });
            console.log(docs);

            // Continue with using retrieved docs
            // in RAG prompts.
            //...
          }
        );
       ```
      </p>
    </section>
    <section>
      <h3>Go</h3>
      <p>
      ```go
      retriever := defineRetriever(db, embedder)

      type input struct {
      	Question string
      	Show     string
      }

      genkit.DefineFlow("askQuestion", func(ctx context.Context, in input) (string, error) {
      	res, err := retriever.Retrieve(ctx, &ai.RetrieverRequest{
      		Document: &ai.Document{Content: []*ai.Part{ai.NewTextPart(in.Question)}},
      		Options:  in.Show,
      	})
      	if err != nil {
      		return "", err
      	}
      	for _, doc := range res.Documents {
      		fmt.Printf("%+v %q\n", doc.Metadata, doc.Content[0].Text)
      	}
      	// Use documents in RAG prompts.
      	return "", nil
      })
      ```
      </p>
    </section>

  </devsite-selector>
</section>
